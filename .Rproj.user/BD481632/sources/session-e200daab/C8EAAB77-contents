---
title: 'BIOSTAT 713: Module 6'
subtitle: 'Special Types of Log-Rank Test'
author: 'Dr. Marissa Ashner'
institute: 'Department of Biostatistics and Bioinformatics'
date: 'Fall 2024'
output: 
  beamer_presentation: 
    latex_engine: xelatex
    keep_tex: true
header-includes: 
  - \titlegraphic{\includegraphics[width=0.3\paperwidth]{../latex_dependencies/duke_som_pic.png}}
  - "\\usepackage{fontspec}"
  - "\\definecolor{dukeblue}{HTML}{003087}"
  - "\\setsansfont{Times New Roman}"
  - "\\setbeamercolor{structure}{fg=dukeblue}"
  - "\\setbeamercolor{title}{fg=dukeblue}"
  - "\\setbeamertemplate{navigation symbols}{}"
  - "\\setbeamertemplate{footline}[frame number]"
---


```{r setup, echo=FALSE, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning=FALSE, fig.width=5, fig.height=3.5)


##########################################################################
##                                                                        ##
##  Author: Marissa Ashner, marissa.ashner@duke.edu                     
##
##  Program: BIOSTAT713_Module6.rmd                            ##
##  Purpose: This program performs analyses to support class notes
##    
##                                                                        ##
##  Input files:  XXX                                       
##
##                                                                        ##
##  Output files: BIOSTAT702_Module6.pdf                      ##
##                                                                        ##
##  Change Log:                                                           ##
##  06/06/2024 File started                                               ##
##  07/02/2024 Page numbers, move case study to its own spot       ## 07/05/2024 Add pre-reading quiz                        
##
########################################################################## 

# setwd()
library(tidyverse)
library(ggplot2)
library(cowplot)
library(lubridate)
library(knitr)
library(survival)

options(knitr.kable.NA="")
options(max.print = .Machine$integer.max)  # don't limit console printing

rm(list=ls())
```


# Module Goals

-   Be able to compare the survival curves of more than 2 groups 
-   Understand the stratified log-rank test 


# Resources for this Module 

### From Canvas 

-   Applied Survival Analysis in R: Chapter 4
-   Cytomegalovirus: Dataset Introduction & Data Dictionary 
       - **These were required pre-reading for this module**
       - The associated paper is also available as a resource
-   Altman Tutorial Part 2: Multivariate data analysis 
       - **This will be required pre-reading for the next module**
    
### Websites 

-   [\textcolor{blue}{\underline{Stanford Log Rank Test Notes}}](https://web.stanford.edu/~lutian/coursepdf/unitweek3.pdf)

# Pre-Reading Quiz 

-   What is the survival outcome for this study? 
-   What is the variable name associated with this outcome? 
-   What grouping variable might we want to compare survival curves for, based on the study objective? 
-   What is the secret word? 


# What if you want to compare more than 2 groups? 

For example, let's say that instead of randomizing our clinical trial cohort to placebo and treatment, we randomize to placebo, treatment A and treatment B. We want to compare the survival curves among all three groups. 

## $H_0: S_P(t) = S_A(t) = S_B(t), \forall t$ 

## $H_1: S_i(t) \neq S_{i'}(t), \exists t$ and for some $i \neq i'$

There is an extension of the log-rank test that can test this hypothesis, for an arbitrary $G$ groups 

# The G Groups Log-Rank Test 

## Notation 

\begin{itemize}
\item $t_1 < t_2 < \ldots < t_m$ are distinct event times for whole cohort 
\item $d_{ij}$ is the number of events at time $t_j$ in group $i$ 
\item $n_{ij}$ is the number at risk just before time $t_j$ in group $i$
\item $d_j$ and $n_j$ are the total number of events / at risk at time $j$ across all groups 
\end{itemize}

Now, we can use this to construct a $G \times 2$ table, instead of simply a $2 \times 2$ like we did previously 

# The Test Statistic

For $i = 1, \ldots, G-1$, calculate 

$$U_i = \sum_{j=1}^m (d_{ij}-E(d_{ij}))$$

Then the vector $\mathbf{U}$ will have $G-1$ elements. 

The test statistic is 

$$T_G = \mathbf{U}^T\mathbf{V}^{-1}\mathbf{U} \sim \chi^2_{G-1}$$

where $\mathbf{V}$ is a $G-1 \times G-1$ matrix where the diagonals are $\sum_j Var(d_{ij})$ as discussed in Module 5, and the off-diagonals are $\sum_j Cov(d_{ij}, d_{i'j})$. 

# Creating the Toy Dataset in R 

\small

```{r}
# creating the data frame
surv_data_toy = data.frame(time = c(3, 4, 7, 9, 9, 11, 20, 
                                    5, 7, 8, 10, 11, 15, 23), 
                           event = c(1, 1, 0, 1, 1, 0, 1, 
                                     1, 1, 1, 0, 1, 1, 0), 
                           group = sample(1:3, 14, 
                                          replace = TRUE)
                           # placebo = 1, 
                           # treatment A = 2, 
                           # treatment B = 3
                           )

# creating the survival object 
surv_object = Surv(surv_data_toy$time, surv_data_toy$event)
```

\normalsize

# The G Groups Log Rank Test in R 

We can simply run the G groups log-rank test in R the same way we run the 2 groups log-rank test, using the \texttt{survdiff()} function. 

\small 

```{r}
logrankg_toy = survdiff(surv_object ~ group, 
                        data = surv_data_toy)
logrankg_toy 
```
\normalsize


# Now what if we want to compare the survival between groups, controlling for a third variable? 

Let's say now that having preexisting diabetes increases the risk of event, no matter which treatment group you are in. We want to control for this when comparing the survival curves between groups, by comparing the groups within each stratum and then combining results across strata.


## $H_0: S_{0k}(t) = S_{1k}(t), \forall t$ and for all $k = 1, \ldots S$

## $H_1: S_{0k}(t) \neq S_{1k}(t), \exists t, \exists k$

# The Test Statistic 

$$T_S = \frac{\left\{\sum_{k = 1}^S \sum_{j=1}^m (d_{0jk}-E(d_{0jk}))\right\}^2}{\sum_{k=1}^S \sum_{j=1}^m Var(d_{0jk})} 
\sim \chi^2_1$$

\begin{itemize}
\item This is essentially a CMH test across all timepoints AND all strata
\item Can be generalized to G groups 
\end{itemize}

# Creating the Toy Dataset in R 

\small

```{r}
# creating the data frame
surv_data_toy = data.frame(time = c(3, 4, 7, 9, 9, 11, 20, 
                                    5, 7, 8, 10, 11, 15, 23), 
                           event = c(1, 1, 0, 1, 1, 0, 1, 
                                     1, 1, 1, 0, 1, 1, 0), 
                           group = c(rep(0, 7), rep(1, 7)),
                           # placebo = 0, treatment = 1
                           diabetes = sample(1:2, 14, 
                                             replace = TRUE)
                           )

# creating the survival object 
surv_object = Surv(surv_data_toy$time, surv_data_toy$event)
```

\normalsize

# The Stratified Log-Rank Test in R 

In the formula for \texttt{survdiff()}, wrap the variable in the \texttt{strata()} function.

\tiny

```{r}
logrank_strat_toy = survdiff(surv_object ~ group + strata(diabetes), 
                        data = surv_data_toy)
logrank_strat_toy 
```

\normalsize

# Q \& A 

## Use the Q \& A feature on Slido to ask questions or upvote your classmates' questions! 


# Module Exercises 




