---
title: 'BIOSTAT 713: Module 17'
subtitle: 'Parametric Survival Models -- Coding in R'
author: 'Dr. Marissa Ashner'
institute: 'Department of Biostatistics and Bioinformatics'
date: 'Fall 2024'
output: 
  beamer_presentation: 
    latex_engine: xelatex
    keep_tex: true
header-includes: 
  - \titlegraphic{\includegraphics[width=0.3\paperwidth]{../latex_dependencies/duke_som_pic.png}}
  - "\\usepackage{fontspec}"
  - "\\usepackage{booktabs}"
  - "\\definecolor{dukeblue}{HTML}{003087}"
  - "\\setsansfont{Times New Roman}"
  - "\\setbeamercolor{structure}{fg=dukeblue}"
  - "\\setbeamercolor{title}{fg=dukeblue}"
  - "\\setbeamertemplate{navigation symbols}{}"
  - "\\setbeamertemplate{footline}[frame number]"
---


```{r setup, echo=FALSE, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning=FALSE, fig.width=5, fig.height=3.5)


##########################################################################
##                                                                        ##
##  Author: Marissa Ashner, marissa.ashner@duke.edu                     
##
##  Program: BIOSTAT713_Module17.rmd                            ##
##  Purpose: This program performs analyses to support class notes
##    
##                                                                        ##
##  Input files:  XXX                                       
##
##                                                                        ##
##  Output files: BIOSTAT713_Module17.pdf                      ##
##                                                                        ##
##  Change Log:                                                           ##
##  08/14/2024 File started                                               ##
##                                                                        ##
########################################################################## 

# setwd()
library(tidyverse)
library(ggplot2)
library(cowplot)
library(lubridate)
library(knitr)
library(survival)
library(survminer)
library(asaur)
library(flexsurv)
library(car)

options(knitr.kable.NA="")
options(max.print = .Machine$integer.max)  # don't limit console printing

rm(list=ls())
```


# Module Goals

-   To be able to run parametric survival models in R 
-   To assess the fit of a chosen parametric distribution and the resulting model 
-   To be able to interpret output from parametric survival models

# Resources for this Module 

### From Canvas 

-   Applied Survival Analysis Using R: Chapter 10
-   Article: "Accelerated Failure Time models provide a useful statistical framework for aging research"
    -   **This was required pre-reading for this module**
    -   Focus on Introduction, Methods (2.2 only), and Discussion
    
### Websites 

-   [\textcolor{blue}{\underline{Parametric Survival Modeling (R Demonstrations)}}](https://devinincerti.com/2019/06/18/parametric_survival.html)

# Pre-Reading Quiz 

-   What does this author argue is a benefit of AFT models over PH models?
-   What do they call the numeric output from their AFT models? 
-   How did they choose which distribution to use for their AFT models?
-   What is the secret word? 

# Dataset 

-   We will be using the `pharmacoSmoking` dataset from the `asaur` package that was used in previous modules (starting with Module 9)
-   We will start by loading the dataset and creating a survival object, as usual
-   Let's use treatment group (`grp`) and years smoking (`yearsSmoking`) as our covariates

\tiny

```{r}
data("pharmacoSmoking")

# change survival times of 0 to greater than 0
pharmacoSmoking$ttr[pharmacoSmoking$ttr == 0] <- 0.001

# create the survival object
surv_obj_ps = Surv(pharmacoSmoking$ttr,
pharmacoSmoking$relapse)
```

\normalsize

# Running an AFT Model 

-   AFT models can be run in R using the `survreg()` function in the `survival` package or the `flexsurvreg()` function in the `flexsurv` package
-   We will specify a Weibull distribution and compare the two methods 
-   Note: The parameterize things *differently* 
    -   The scale $b$ in `survreg` = the reciprocal of shape $a$ in `flexsurvreg`
    -   The intercept in `survreg` = the log of the scale $b$ in `flexsurvreg`
-   `flexsurvreg` corresponds more directly to the standard parameterization 

# AFT Model -- survreg

\tiny

```{r}
survreg_weibull = survreg(surv_obj_ps ~ grp + yearsSmoking, 
                          data = pharmacoSmoking, 
                          dist = "weibull")
summary(survreg_weibull)
```

\normalsize

# AFT Model -- flexsurvreg

\tiny

```{r}
flexsurvreg_weibull = flexsurvreg(surv_obj_ps ~ grp + yearsSmoking, 
                          data = pharmacoSmoking, 
                          dist = "weibull")
flexsurvreg_weibull
```

\normalsize

# Running a Parametric PH Model 

-   `survreg` doesn't support PH models with their included distributions 
-   `flexsurvreg` states which distributions use PH and which use AFT 
    -   In the case of the Weibull distribution, to use a PH model instead of the AFT, you must specify the distribution as `weibullph`
    -   Note that the exponential distribution corresponds to a PH model with this package

# PH Model -- flexsurvreg 

\tiny

```{r}
flexsurvreg_weibullph = flexsurvreg(surv_obj_ps ~ grp + yearsSmoking, 
                          data = pharmacoSmoking, 
                          dist = "weibullph")
flexsurvreg_weibullph
```
\normalsize

# Comparing AFT and PH Weibull Models 

-   As we learned (or will learn) from completing the Module 16 exercises, the parameter estimates from a PH Weibull model should be the negated parameter estimates from the AFT Weibull model, multiplied by the shape estimate

\scriptsize

```{r}
# PH Weibull Model Parameter Estimates 
flexsurvreg_weibullph$res[,1]

# AFT Weibull Model Parameter Estimates * - shape
-1*
  flexsurvreg_weibull$res[1,1]*
  flexsurvreg_weibull$res[3:4,1]
```
\normalsize

# Interpretation 

## PH Model 

**HR = ** 1.74 (CI: 1.14, 2.66). 
Controlling for number of years smoking, the hazard of relapse in the group with the patch only treatment is 1.74 times the hazard of relapse in the combination group.

## AFT Model 

**Coefficient: ** -1.49 (CI: -2.64, -0.34), **Exponentiated Coefficient: ** 0.226 (CI: 0.072, 0.715) 
**Acceleration Factor: ** 4.43 (CI: 1.40, 13.97)
Controlling for number of years smoking, the expected relapse time changes by a factor of 0.226 for those in the patch only treatment group compared to the combination group. OR, the relapse time is 4.43 times accelerated in the patch only group compared to the combination group. 


# Assessing Fit of the Parametric Distribution 

\scriptsize

In order to assess the fit of the distribution picked for an AFT model, you can plot an intercept only AFT model with that distribution and overlay it with the KM curve, to see if they overlap. 

\tiny

```{r, message = FALSE}
# Fit intercept-only models
weibull_aft <- flexsurvreg(surv_obj_ps ~ 1, data = pharmacoSmoking, dist = "weibull") 
lognorm_aft <- flexsurvreg(surv_obj_ps ~ 1, data = pharmacoSmoking, dist = "lnorm")
km_fit <- survfit(surv_obj_ps ~ 1, data = pharmacoSmoking)

# Extract the survival curve from the Weibull and lognormal AFT models
aft_curves <- data.frame(
  time = seq(from = min(pharmacoSmoking$ttr), to = max(pharmacoSmoking$ttr), by = 0.1),
  surv_w = predict(weibull_aft, times = seq(from = min(pharmacoSmoking$ttr), 
                                            to = max(pharmacoSmoking$ttr), by = 0.1), 
                   newdata = pharmacoSmoking[1,], 
                   type = "survival")[[1]][[1]][,2] %>% unlist(), 
  surv_l = predict(lognorm_aft, times = seq(from = min(pharmacoSmoking$ttr), 
                                            to = max(pharmacoSmoking$ttr), by = 0.1), 
                   newdata = pharmacoSmoking[1,], 
                   type = "survival")[[1]][[1]][,2] %>% unlist()
)

plot = ggsurvplot(km_fit, data = pharmacoSmoking, conf.int = TRUE, 
           color = "red")$plot + 
  geom_line(data = aft_curves, 
            aes(x = time, y = surv_w, col = "Weibull AFT")) + 
  geom_line(data = aft_curves, 
            aes(x = time, y = surv_l, col = "Lognormal AFT")) + 
  geom_segment(aes(x = 0, xend = 0, y = 1, yend = 1, 
                   color = "Kaplan-Meier"),
               show.legend = TRUE, linetype = "solid") +  # Add dummy line
  scale_color_manual(values = c("Weibull AFT" = "blue",
                                "Lognormal AFT" = "orange",
                                "Kaplan-Meier" = "red")) + 
  labs(color = "")
```

\normalsize 

# Assessing Fit of the Parametric Distribution 

\tiny 

```{r, out.width="80%", out.height="60%"}
plot
```

# Diagnostics 

-   **Checking Proportional Hazards: ** for parametric PH models, you still have to check proportional hazards. You can do this by, as done with cox models, plotting the log-cumulative hazard (equal to complementary loglog survival) vs (log) time and looking for parallel lines when stratified by a covariate.

-   **Cox-Snell Residuals: ** Defined below, Cox-Snell residuals should follow an Exponential(1) distribution if the model is fitted correctly. Censored observations also have censored cox-snell residuals.
    -   Plot $-\log\hat{S}_{KM}(r_{C_i})$ vs $r_{C_i}$; if this follows a straight line $y = x$, then the model is fitted correctly
    -   OR plot a QQ-plot using Exp(1) as the reference 

$$r_{C_i} = -\log S_{\epsilon_i}\left(\frac{\log t_i -\hat{\mu} - \hat{\alpha}^T\mathbf{z}_i}{\hat{\sigma}}\right)$$

# Plotting Cox-Snell Residuals 

\scriptsize

-   You can calculate cox-snell residuals with a `flexsurvreg` object using the `residuals()` function
-   The `car` package has a `qqPlot()` function where you can specify the reference distribution

\tiny

```{r, out.width="80%", out.height="60%"}
# get residuals
cs_resid = residuals(flexsurvreg_weibull, type = "coxsnell")

# plot 
qqPlot(cs_resid, distribution = "exp")
```

\normalsize


# Q \& A 

## Use the Q \& A feature on Slido to ask questions or upvote your classmates' questions! 


# Module Exercises 

**Use the `pharmacoSmoking` dataset from the `asaur` package:** 

The study investigators want to quantify the association of certain predictors with hazard of relapse. They are interested in looking at treatment group (grp) and level of smoking (levelSmoking).

\begin{enumerate}
\item Run a parametric proportional hazards model with an exponential distribution assumption. Output the coefficient estimates and interpret the hazard ratio for the treatment group. 
\item Run an AFT model with an exponential distribution assumption. Output the coefficient estimates and interpret the acceleration factor for the treatment group. 
\item Determine the relationship between the coefficients for the exponential PH and AFT models. What do you notice about the Hazard Ratio and the Acceleration Factor? 
\end{enumerate}



