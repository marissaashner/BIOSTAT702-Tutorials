---
title: 'BIOSTAT 713: Module 5'
subtitle: 'Comparing two Survival Curves'
author: 'Dr. Marissa Ashner'
institute: 'Department of Biostatistics and Bioinformatics'
date: 'Fall 2024'
output: 
  beamer_presentation: 
    latex_engine: xelatex
    keep_tex: true
header-includes: 
  - \titlegraphic{\includegraphics[width=0.3\paperwidth]{../latex_dependencies/duke_som_pic.png}}
  - "\\usepackage{fontspec}"
  - "\\definecolor{dukeblue}{HTML}{003087}"
  - "\\setsansfont{Times New Roman}"
  - "\\setbeamercolor{structure}{fg=dukeblue}"
  - "\\setbeamercolor{title}{fg=dukeblue}"
  - "\\usepackage{booktabs}"
  - "\\usepackage{amsmath}"
  - "\\usepackage{xcolor}"
  - "\\setbeamertemplate{navigation symbols}{}"
  - "\\setbeamertemplate{footline}[frame number]"
---


```{r setup, echo=FALSE, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(warning=FALSE, fig.width=5, fig.height=3.5)


##########################################################################
##                                                                        ##
##  Author: Marissa Ashner, marissa.ashner@duke.edu                     
##
##  Program: BIOSTAT713_Module5.rmd                            ##
##  Purpose: This program performs analyses to support class notes
##    
##                                                                        ##
##  Input files:  XXX                                       
##
##                                                                        ##
##  Output files: BIOSTAT713_Module5.pdf                      ##
##                                                                        ##
##  Change Log:                                                           ##
##  05/31/2024 File started      
##  07/02/2024 Add page numbers, change url color, module goals, ... 
##                                                                        ##
########################################################################## 

# setwd()
library(tidyverse)
library(ggplot2)
library(cowplot)
library(lubridate)
library(knitr)
library(survival) 
library(survminer)
library(ggsurvfit)

options(knitr.kable.NA="")
options(max.print = .Machine$integer.max)  # don't limit console printing

rm(list=ls())
```


# Module Goals

-   Be able to compare survival curves from two groups visually using KM curves and statistically using the log-rank test

# Resources for this Module 

### From Canvas 

-   Applied Survival Analysis in R: Chapter 4
-   Cytomegalovirus: Dataset Introduction & Data Dictionary 
       - **These will be required pre-reading for the next module**
       - The associated paper is also available as a resource
    
### Websites 

-   [\textcolor{blue}{\underline{Comparing Survival Curves}}](https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/BS704_Survival5.html#:~:text=The%20log%20rank%20test%20is,identical%20(overlapping)%20or%20not.)
-   [\textcolor{blue}{\underline{Stanford Log Rank Test Notes}}](https://web.stanford.edu/~lutian/coursepdf/unitweek3.pdf)
-   [\textcolor{blue}{\underline{Toward Data Science article on Log-Rank Tests}}](https://towardsdatascience.com/survival-analysis-in-clinical-trials-log-rank-test-8f1229e7f0f0)
    -   **This was required pre-reading for this module**


# Pre-Reading Quiz 

-   What statistical test from BIOSTAT702 is the log-rank test similar to?
-   How is it decided how many contingency tables would be needed for the log-rank test? 
-   Will the log-rank test change if my event times change from $(1, 3, 7, 10)$, to $(1, 5, 7, 10)$? 
-   What is the secret word? 

# Remember: 

Last time, we learned how to estimate and plot the survival function for a group of observations. 

Now, what if we want to **compare** the survival functions for two different groups of observations? 

# Comparison of Survival in 2 Groups 

Consider this toy dataset that represents a randomized clinical trial. Half of the group is randomized to a placebo, and half randomized to a treatment. We want to see if the survival function (let's say the event is death) is the same between these two groups. 

## Group 1 (Placebo)
\begin{center}
3 \hspace{0.1in} 4 \hspace{0.1in} 7* \hspace{0.1in}  9 \hspace{0.1in}  9 \hspace{0.1in}  11*  \hspace{0.1in}  20
\end{center}

## Group 2 (Treatment)
\begin{center}
5 \hspace{0.1in} 7 \hspace{0.1in} 8 \hspace{0.1in}  10* \hspace{0.1in}  11 \hspace{0.1in}  15  \hspace{0.1in}  23*
\end{center}

# How to estimate these curves in R? 

\tiny

```{r}
# creating the data frame
surv_data_toy = data.frame(time = c(3, 4, 7, 9, 9, 11, 20, 
                                    5, 7, 8, 10, 11, 15, 23), 
                           event = c(1, 1, 0, 1, 1, 0, 1, 
                                     1, 1, 1, 0, 1, 1, 0), 
                           group = c(rep(0, 7), rep(1, 7)) 
                           # placebo = 0, treatment = 1
                           )

# creating the survival object 
surv_object = Surv(surv_data_toy$time, surv_data_toy$event)
surv_object

# estimating the km curves
km_toy = survfit(surv_object ~ group,
                 data = surv_data_toy)
```

\normalsize

# How to estimate these curves in R?

\tiny

```{r}
summary(km_toy)
```

\normalsize 

# How to visualize these curves in R?

\tiny

```{r,  out.width="80%", out.height="60%"}
ggsurvplot(km_toy, data = surv_data_toy,
           conf.int = FALSE, 
           risk.table = TRUE,
           tables.height = 0.4,
           legend = "none")
```

\normalsize 

# How do we test for equality of $S(t)$?

## $H_0: S_0(t) = S_1(t), \forall t$ 

## $H_1: S_0(t) \neq S_1(t), \exists t$

Note: You can also use a one-sided alternative hypothesis. We will focus on two-sided hypotheses. 

# Recall from BIOSTAT702: The Cochran-Mantel-Haentzel (CMH) Test 

\begin{itemize}
\item \textbf{Goal:} Test for an association between two binary variables, controlling for a third categorical variable 
\item 3 Variables 
\begin{itemize}
\item Binary Predictor (ROWS)
\item Binary Outcome (COLUMNS)
\item Categorical Variable (strata with K levels)
\end{itemize}
\item For each stratum, we have a 2 \times 2 table 
\end{itemize}

# The CMH Test 

\begin{itemize}
\item Assume the marginal totals of these 2 \times 2 tables are fixed 
\item $Y_{11i}$ follows a hypergeometric distribution
\end{itemize}

The Test Statistic is calculated as 

$$T = \frac{(\sum_{i=1}^K (O_i-E_i))^2}{\sum_{i=1}^K Var(Y_{11i})} \sim \chi^2_1$$

where $O_i = Y_{11i}$, $E_i = \frac{n_{1.i}n_{.1i}}{n_i}$, and $Var(Y_{11i}) = \frac{n_{1.i}n_{2.i}n_{.1i}n_{.2i}}{n_i^2(n_i-1)}$


\begin{table}
    \centering
    \begin{tabular}{lcc|c}
        \toprule
        \textit{Stratum i} & \textbf{Outcome 1} & \textbf{Outcome 2} \\
        \midrule
        \textbf{Group 1} & $Y_{11i}$ & $Y_{12i}$ & $n_{1.i}$ \\
        \textbf{Group 2} & $Y_{21i}$ & $Y_{22i}$ & $n_{2.i}$\\
        \midrule
        & $n_{.1i}$ & $n_{.2i}$ & $n_{i}$ \\
        \bottomrule
    \end{tabular}
\end{table}


# The Log-Rank Test for Comparing 2 Survival Curves 

\begin{itemize}
\item This can be written as a CMH Test 
\item Let each distinct event time be the strata 
\item For each strata (and 2\times 2 table), let the rows be the group (placebo vs treatment) and let the columns be binary (event occurred at the event time vs. occurred past the event time) 
\item The row totals will be those at risk just before the event time 
\end{itemize}

\begin{table}
    \centering
    \begin{tabular}{lcc|c}
        \toprule
        \textit{event time $t_j$} & \textbf{Death at $t_j$} & \textbf{Death $> t_j$} & At risk before $t_j$ \\
        \midrule
        \textbf{Placebo} & $d_{0j}$ & $n_{0j}-d_{0j}$ & $n_{0j}$ \\
        \textbf{Treatment} & $d_{1j}$ & $n_{1j}-d_{1j}$ & $n_{1j}$\\
        \midrule
        & $d_{j}$ & $n_{j}-d_{j}$ & $n_{j}$ \\
        \bottomrule
    \end{tabular}
\end{table}

# Log Rank Test in R 

We can run the log-rank test in R using the \texttt{survdiff()} function. 

\small

```{r}
logrank_toy = survdiff(surv_object ~ group,
                       data = surv_data_toy)

logrank_toy
```

\normalsize

# Adding Log Rank Test p-value to Survival Curves in R

\tiny

```{r,  out.width="80%", out.height="60%"}
ggsurvplot(km_toy, data = surv_data_toy,
           conf.int = FALSE, 
           risk.table = TRUE,
           pval = TRUE,
           tables.height = 0.4,
           legend = "none")
```

\normalsize

# Comparing to the CMH Test in R 

\tiny

```{r}
# gather the study group, the time and the event status for each participant, 
# and arrange the time from smallest to largest
toy_cmh = surv_data_toy %>% arrange(time)
toy_cmh
```

\normalsize


# Comparing to the CMH Test in R 

\small

```{r}
# what are the event times? 
toy_cmh %>% filter(event == 1) %>% select(time, group)
```


# Comparing to the CMH Test in R 

We need one 2 \times 2 table for each event time. 

\small

```{r}
table3 = as.table(matrix(c(1, 0, 6, 7), nrow = 2))
table4 = as.table(matrix(c(1, 0, 5, 7), nrow = 2))
table5 = as.table(matrix(c(0, 1, 5, 6), nrow = 2))
table7 = as.table(matrix(c(0, 1, 5, 5), nrow = 2))
table8 = as.table(matrix(c(0, 1, 4, 4), nrow = 2))
table9 = as.table(matrix(c(2, 0, 2, 4), nrow = 2))
table11 = as.table(matrix(c(0, 1, 2, 2), nrow = 2))
table15 = as.table(matrix(c(0, 1, 1, 1), nrow = 2))
table20 = as.table(matrix(c(1, 0, 0, 1), nrow = 2))

cmh_array = abind::abind(table3, table4, table5, 
                         table7, table8, table9,
                         table11, table15, table20,
                         along = 3)
```

# Comparing to the CMH Test in R 

\tiny

```{r}
mantelhaen.test(cmh_array, correct=FALSE)

logrank_toy
```

# Weighted Log Rank Tests 

$$T_W = \frac{\left\{\sum_{j=1}^K \textcolor{red}{w_j}(d_{0j}-E(d_{0j}))\right\}^2}{\sum_{i=1}^K \textcolor{red}{w_j^2}Var(d_{0j})} \sim \chi^2_1$$
\begin{itemize}
\item when $w_j = w$ (i.e., a constant) for all $j$, simplifies to the \textbf{log-rank test}
\item when $w_j = n_j$, called the \textbf{Wilcoxon test} (aka Gehan-Wilcoxon; Breslow)
\item when $w_j = \hat{S}(t_j)$, called the \textbf{Peto-Peto-Prentice} variation (where $\hat{S}(.)$ is the KM survival estimate)
\end{itemize}

# Weighted log-rank tests in R 

\small

```{r}
logrank_weighted_toy = survdiff(surv_object ~ group,
                                rho = 1, 
                                # Peto-Peto-Prentice variation
                       data = surv_data_toy)

logrank_weighted_toy
```

# Which test to use? 

\begin{itemize}
\item the log-rank test is the most commonly used 
\item the log-rank test is most powerful when hazards are proportional 
\item the Wilcoxon and Peto-Peto tests both emphasize early differences in survival, since they upweight by $n_j$ or $\hat{S}(t_j)$, which both decrease
\item ... and therefore, these are less sensitive to differences at later survival times
\end{itemize}

# Q \& A 

## Use the Q \& A feature on Slido to ask questions or upvote your classmates' questions! 


# Module Exercises 




